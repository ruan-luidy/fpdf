<UserControl
  x:Class="fpdf.Wpf.Views.Controls.FileListControl"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:behaviors="clr-namespace:fpdf.Wpf.Behaviors"
  xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
  xmlns:ext="clr-namespace:fpdf.Wpf.Extensions"
  xmlns:hc="https://handyorg.github.io/handycontrol"
  xmlns:icon="http://metro.mahapps.com/winfx/xaml/iconpacks"
  xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
  xmlns:models="clr-namespace:fpdf.Core.Models;assembly=fpdf.Core"
  xmlns:vm="clr-namespace:fpdf.Wpf.ViewModels"
  behaviors:FileDragDropBehavior.DropCommand="{Binding DropFilesCommand}"
  d:DataContext="{d:DesignInstance Type=vm:FileListViewModel}"
  mc:Ignorable="d">

  <UserControl.Resources>
    <!--  Estilo customizado do DataGridCell  -->
    <Style
      x:Key="CustomDataGridCellStyle"
      BasedOn="{StaticResource DataGridCellStyle.Small}"
      TargetType="DataGridCell">
      <Style.Triggers>
        <MultiTrigger>
          <MultiTrigger.Conditions>
            <Condition Property="IsSelected" Value="True" />
            <Condition Property="Selector.IsSelectionActive" Value="False" />
          </MultiTrigger.Conditions>
          <Setter Property="Background" Value="Transparent" />
        </MultiTrigger>
      </Style.Triggers>
    </Style>

    <!--  Estilo customizado do DataGridRow com efeitos visuais  -->
    <Style
      x:Key="CustomDataGridRowStyle"
      BasedOn="{StaticResource DataGridRowStyle.Small}"
      TargetType="DataGridRow">
      <Setter Property="Background" Value="Transparent" />
      <Setter Property="BorderThickness" Value="1" />
      <Setter Property="BorderBrush" Value="Transparent" />
      <Style.Triggers>
        <Trigger Property="IsMouseOver" Value="True">
          <Setter Property="Background" Value="{DynamicResource SecondaryRegionBrush}" />
        </Trigger>
        <Trigger Property="IsSelected" Value="True">
          <Setter Property="Background" Value="{DynamicResource SecondaryRegionBrush}" />
          <Setter Property="BorderBrush" Value="{DynamicResource SecondaryBorderBrush}" />
        </Trigger>
        <MultiTrigger>
          <MultiTrigger.Conditions>
            <Condition Property="IsSelected" Value="True" />
            <Condition Property="Selector.IsSelectionActive" Value="False" />
          </MultiTrigger.Conditions>
          <Setter Property="Background" Value="{DynamicResource SecondaryRegionBrush}" />
          <Setter Property="BorderBrush" Value="{DynamicResource SecondaryBorderBrush}" />
        </MultiTrigger>
      </Style.Triggers>
    </Style>
  </UserControl.Resources>

  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
      <RowDefinition Height="Auto" />
    </Grid.RowDefinitions>

    <!--  Barra de busca e acoes  -->
    <Border
      Grid.Row="0"
      Margin="5"
      Padding="0"
      Background="{StaticResource DarkOpacityBrush}">
      <Border.Style>
        <Style BasedOn="{StaticResource BorderRegion}" TargetType="Border">
          <Style.Triggers>
            <DataTrigger Binding="{Binding ElementName=SearchTextBox, Path=IsFocused}" Value="True">
              <Setter Property="BorderBrush" Value="{DynamicResource PrimaryBrush}" />
            </DataTrigger>
          </Style.Triggers>
        </Style>
      </Border.Style>
      <Grid>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="Auto" />
          <ColumnDefinition Width="Auto" />
          <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>

        <Border />
        <hc:TextBox
          x:Name="SearchTextBox"
          Grid.Column="0"
          hc:InfoElement.Placeholder="{ext:Loc FileList_SearchPlaceholder}"
          Background="Transparent"
          BorderThickness="0"
          Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged, Delay=300}" />

        <Button
          Grid.Column="1"
          Margin="4,0,0,0"
          Style="{StaticResource ButtonIconCustom}">
          <icon:PackIconPhosphorIcons Kind="MagnifyingGlass" />
        </Button>

        <Button
          Grid.Column="2"
          Margin="4,0,0,0"
          Command="{Binding RefreshCommand}"
          Style="{StaticResource ButtonIconCustom}"
          ToolTip="{ext:Loc FileList_RefreshTooltip}">
          <icon:PackIconPhosphorIcons Kind="ArrowClockwise" />
        </Button>

        <Button
          Grid.Column="3"
          Margin="4,0,0,0"
          Command="{Binding PrintSelectedCommand}"
          Style="{StaticResource ButtonIconCustom}"
          ToolTip="{ext:Loc FileList_PrintSelectedTooltip}">
          <icon:PackIconPhosphorIcons Kind="Printer" />
        </Button>
      </Grid>
    </Border>


    <!--  Lista de arquivos  -->
    <DataGrid
      x:Name="FilesDataGrid"
      Grid.Row="1"
      Margin="5,0"
      hc:BorderElement.CornerRadius="4,4,0,0"
      AutoGenerateColumns="False"
      Background="{DynamicResource DarkOpacityBrush}"
      BorderThickness="1,1,1,0"
      CanUserSortColumns="True"
      EnableRowVirtualization="True"
      HeadersVisibility="Column"
      IsReadOnly="True"
      ItemsSource="{Binding FilesView}"
      RequestBringIntoView="DataGrid_RequestBringIntoView"
      SelectedItem="{Binding SelectedFile}"
      SelectionChanged="DataGrid_SelectionChanged"
      SelectionMode="Single"
      Style="{StaticResource DataGrid.Small}"
      VirtualizingPanel.IsVirtualizing="True"
      VirtualizingPanel.VirtualizationMode="Recycling">

      <DataGrid.CellStyle>
        <Style BasedOn="{StaticResource CustomDataGridCellStyle}" TargetType="DataGridCell">
          <EventSetter Event="RequestBringIntoView" Handler="DataGridCell_RequestBringIntoView" />
        </Style>
      </DataGrid.CellStyle>

      <DataGrid.RowStyle>
        <Style BasedOn="{StaticResource CustomDataGridRowStyle}" TargetType="DataGridRow">
          <Setter Property="FocusVisualStyle" Value="{x:Null}" />
          <EventSetter Event="RequestBringIntoView" Handler="DataGridRow_RequestBringIntoView" />
        </Style>
      </DataGrid.RowStyle>

      <DataGrid.Columns>
        <!--  Checkbox de selecao  -->
        <DataGridTemplateColumn MinWidth="40" MaxWidth="40">
          <DataGridTemplateColumn.CellTemplate>
            <DataTemplate DataType="{x:Type models:PdfFileInfo}">
              <CheckBox HorizontalAlignment="Center" IsChecked="{Binding IsSelected, UpdateSourceTrigger=PropertyChanged}" />
            </DataTemplate>
          </DataGridTemplateColumn.CellTemplate>
        </DataGridTemplateColumn>

        <!--  Icone PDF  -->
        <DataGridTemplateColumn MinWidth="40" MaxWidth="40">
          <DataGridTemplateColumn.CellTemplate>
            <DataTemplate DataType="{x:Type models:PdfFileInfo}">
              <Grid>
                <icon:PackIconPhosphorIcons
                  x:Name="FileIcon"
                  Width="18"
                  Height="18"
                  HorizontalAlignment="Center"
                  VerticalAlignment="Center"
                  Foreground="{DynamicResource DangerBrush}"
                  Kind="{Binding FileIcon}"
                  Visibility="{Binding IsLoadingThumbnail, Converter={StaticResource Boolean2VisibilityReConverter}}" />
                <hc:CircleProgressBar
                  Width="16"
                  Height="16"
                  HorizontalAlignment="Center"
                  VerticalAlignment="Center"
                  ArcThickness="2"
                  Background="Transparent"
                  IsIndeterminate="True"
                  Visibility="{Binding IsLoadingThumbnail, Converter={StaticResource Boolean2VisibilityConverter}}" />
              </Grid>
              <DataTemplate.Triggers>
                <DataTrigger Binding="{Binding FileExtension}" Value=".pdf">
                  <Setter TargetName="FileIcon" Property="Foreground" Value="{DynamicResource DangerBrush}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding FileExtension}" Value=".step">
                  <Setter TargetName="FileIcon" Property="Foreground" Value="{DynamicResource PrimaryBrush}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding FileExtension}" Value=".stp">
                  <Setter TargetName="FileIcon" Property="Foreground" Value="{DynamicResource PrimaryBrush}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding FileExtension}" Value=".dwg">
                  <Setter TargetName="FileIcon" Property="Foreground" Value="{DynamicResource WarningBrush}" />
                </DataTrigger>
              </DataTemplate.Triggers>
            </DataTemplate>
          </DataGridTemplateColumn.CellTemplate>
        </DataGridTemplateColumn>

        <!--  Nome do arquivo  -->
        <DataGridTemplateColumn
          Width="*"
          Header="{ext:Loc FileList_ColumnName}"
          SortMemberPath="FileName">
          <DataGridTemplateColumn.CellTemplate>
            <DataTemplate DataType="{x:Type models:PdfFileInfo}">
              <TextBlock VerticalAlignment="Center">
                <behaviors:TextBlockHighlightBehavior.HighlightedInlines>
                  <MultiBinding Converter="{StaticResource TextHighlightConverter}">
                    <Binding Path="FileName" />
                    <Binding Path="DataContext.SearchText" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                  </MultiBinding>
                </behaviors:TextBlockHighlightBehavior.HighlightedInlines>
              </TextBlock>
            </DataTemplate>
          </DataGridTemplateColumn.CellTemplate>
        </DataGridTemplateColumn>

        <!--  Paginas  -->
        <DataGridTextColumn
          Width="50"
          Binding="{Binding PageCount}"
          Header="{ext:Loc FileList_ColumnPages}"
          SortMemberPath="PageCount" />

        <!--  Tamanho  -->
        <DataGridTextColumn
          Width="80"
          Binding="{Binding FileSizeFormatted}"
          Header="{ext:Loc FileList_ColumnSize}"
          SortMemberPath="FileSize" />

        <!--  Data  -->
        <DataGridTextColumn
          Width="120"
          Binding="{Binding LastModifiedFormatted}"
          Header="{ext:Loc FileList_ColumnModified}"
          SortMemberPath="LastModified" />
      </DataGrid.Columns>

      <DataGrid.ContextMenu>
        <ContextMenu Style="{StaticResource ContextMenu.Small}">
          <MenuItem Command="{Binding PlacementTarget.DataContext.PrintSelectedCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" Header="{ext:Loc FileList_MenuPrint}">
            <MenuItem.Icon>
              <icon:PackIconPhosphorIcons Kind="Printer" />
            </MenuItem.Icon>
          </MenuItem>
          <Separator />
          <MenuItem Command="{Binding PlacementTarget.DataContext.SelectAllCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" Header="{ext:Loc FileList_MenuSelectAll}">
            <MenuItem.Icon>
              <icon:PackIconPhosphorIcons Kind="CheckSquare" />
            </MenuItem.Icon>
          </MenuItem>
          <MenuItem Command="{Binding PlacementTarget.DataContext.ClearSelectionCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" Header="{ext:Loc FileList_MenuClearSelection}">
            <MenuItem.Icon>
              <icon:PackIconPhosphorIcons Kind="Square" />
            </MenuItem.Icon>
          </MenuItem>
        </ContextMenu>
      </DataGrid.ContextMenu>

      <DataGrid.InputBindings>
        <KeyBinding
          Key="A"
          Command="{Binding SelectAllCommand}"
          Modifiers="Ctrl" />
        <KeyBinding
          Key="P"
          Command="{Binding PrintSelectedCommand}"
          Modifiers="Ctrl" />
      </DataGrid.InputBindings>
    </DataGrid>

    <!--  Barra de status  -->
    <Border
      Grid.Row="2"
      Margin="5,0"
      Padding="8,4"
      Background="{DynamicResource DarkOpacityBrush}"
      BorderBrush="{DynamicResource BorderBrush}"
      BorderThickness="1"
      CornerRadius="0,0,4,4">
      <StackPanel Orientation="Horizontal">
        <TextBlock Text="{Binding FileCountText}" />
        <hc:Divider Orientation="Vertical" Visibility="{Binding SelectedCount, Converter={StaticResource Int2VisibilityConverter}}" />
        <TextBlock Text="{Binding SelectedCountText}" Visibility="{Binding SelectedCount, Converter={StaticResource Int2VisibilityConverter}}" />
      </StackPanel>
    </Border>
  </Grid>
</UserControl>

