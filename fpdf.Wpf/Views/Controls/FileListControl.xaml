<UserControl
  x:Class="fpdf.Wpf.Views.Controls.FileListControl"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
  xmlns:hc="https://handyorg.github.io/handycontrol"
  xmlns:icon="http://metro.mahapps.com/winfx/xaml/iconpacks"
  xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
  xmlns:models="clr-namespace:fpdf.Core.Models;assembly=fpdf.Core"
  xmlns:vm="clr-namespace:fpdf.Wpf.ViewModels"
  d:DataContext="{d:DesignInstance Type=vm:FileListViewModel}"
  mc:Ignorable="d">

  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
      <RowDefinition Height="Auto" />
    </Grid.RowDefinitions>

    <!--  Barra de busca e acoes  -->
    <Grid Grid.Row="0" Margin="4">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="*" />
        <ColumnDefinition Width="Auto" />
        <ColumnDefinition Width="Auto" />
      </Grid.ColumnDefinitions>

      <hc:SearchBar
        Grid.Column="0"
        hc:InfoElement.Placeholder="Buscar PDF..."
        Style="{StaticResource SearchBarPlus}"
        Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged, Delay=300}" />

      <Button
        Grid.Column="1"
        Margin="4,0,0,0"
        Command="{Binding RefreshCommand}"
        Style="{StaticResource ButtonIcon}"
        ToolTip="Atualizar">
        <icon:PackIconPhosphorIcons Kind="ArrowClockwise" />
      </Button>

      <Button
        Grid.Column="2"
        Margin="4,0,0,0"
        Command="{Binding PrintSelectedCommand}"
        Style="{StaticResource ButtonIcon}"
        ToolTip="Imprimir Selecionados">
        <icon:PackIconPhosphorIcons Kind="Printer" />
      </Button>
    </Grid>

    <!--  Lista de arquivos  -->
    <DataGrid
      Grid.Row="1"
      AutoGenerateColumns="False"
      CanUserSortColumns="True"
      EnableRowVirtualization="True"
      GridLinesVisibility="Horizontal"
      HeadersVisibility="Column"
      IsReadOnly="True"
      ItemsSource="{Binding FilesView}"
      SelectedItem="{Binding SelectedFile}"
      SelectionMode="Extended"
      VirtualizingPanel.IsVirtualizing="True"
      VirtualizingPanel.VirtualizationMode="Recycling">

      <DataGrid.Columns>
        <!--  Checkbox de selecao  -->
        <DataGridTemplateColumn Width="30">
          <DataGridTemplateColumn.CellTemplate>
            <DataTemplate DataType="{x:Type models:PdfFileInfo}">
              <CheckBox HorizontalAlignment="Center" IsChecked="{Binding IsSelected, UpdateSourceTrigger=PropertyChanged}" />
            </DataTemplate>
          </DataGridTemplateColumn.CellTemplate>
        </DataGridTemplateColumn>

        <!--  Thumbnail  -->
        <DataGridTemplateColumn Width="50" Header="">
          <DataGridTemplateColumn.CellTemplate>
            <DataTemplate DataType="{x:Type models:PdfFileInfo}">
              <Grid Width="40" Height="40">
                <Image
                  Source="{Binding Thumbnail}"
                  Stretch="Uniform"
                  Visibility="{Binding Thumbnail, Converter={StaticResource Object2VisibilityConverter}}" />
                <icon:PackIconPhosphorIcons
                  Width="24"
                  Height="24"
                  HorizontalAlignment="Center"
                  VerticalAlignment="Center"
                  Foreground="{DynamicResource DangerBrush}"
                  Kind="FilePdf"
                  Visibility="{Binding Thumbnail, Converter={StaticResource Object2VisibilityReConverter}}" />
                <hc:LoadingCircle
                  Width="20"
                  Height="20"
                  Visibility="{Binding IsLoadingThumbnail, Converter={StaticResource Boolean2VisibilityConverter}}" />
              </Grid>
            </DataTemplate>
          </DataGridTemplateColumn.CellTemplate>
        </DataGridTemplateColumn>

        <!--  Nome do arquivo  -->
        <DataGridTextColumn
          Width="*"
          Binding="{Binding FileName}"
          Header="Nome"
          SortMemberPath="FileName" />

        <!--  Paginas  -->
        <DataGridTextColumn
          Width="50"
          Binding="{Binding PageCount}"
          Header="Pag."
          SortMemberPath="PageCount" />

        <!--  Tamanho  -->
        <DataGridTextColumn
          Width="80"
          Binding="{Binding FileSizeFormatted}"
          Header="Tamanho"
          SortMemberPath="FileSize" />

        <!--  Data  -->
        <DataGridTextColumn
          Width="120"
          Binding="{Binding LastModifiedFormatted}"
          Header="Modificado"
          SortMemberPath="LastModified" />
      </DataGrid.Columns>

      <DataGrid.ContextMenu>
        <ContextMenu>
          <MenuItem Command="{Binding PrintSelectedCommand}" Header="Imprimir">
            <MenuItem.Icon>
              <icon:PackIconPhosphorIcons Kind="Printer" />
            </MenuItem.Icon>
          </MenuItem>
          <Separator />
          <MenuItem Command="{Binding SelectAllCommand}" Header="Selecionar Todos">
            <MenuItem.Icon>
              <icon:PackIconPhosphorIcons Kind="CheckSquare" />
            </MenuItem.Icon>
          </MenuItem>
          <MenuItem Command="{Binding ClearSelectionCommand}" Header="Limpar Selecao">
            <MenuItem.Icon>
              <icon:PackIconPhosphorIcons Kind="Square" />
            </MenuItem.Icon>
          </MenuItem>
        </ContextMenu>
      </DataGrid.ContextMenu>

      <DataGrid.InputBindings>
        <KeyBinding
          Key="A"
          Command="{Binding SelectAllCommand}"
          Modifiers="Ctrl" />
        <KeyBinding
          Key="P"
          Command="{Binding PrintSelectedCommand}"
          Modifiers="Ctrl" />
      </DataGrid.InputBindings>
    </DataGrid>

    <!--  Barra de status  -->
    <Border
      Grid.Row="2"
      Padding="8,4"
      Background="{DynamicResource RegionBrush}">
      <StackPanel Orientation="Horizontal">
        <TextBlock Text="{Binding FileCount, StringFormat='{}{0} arquivos'}" />
        <TextBlock Text=" | " Visibility="{Binding SelectedCount, Converter={StaticResource Int2VisibilityConverter}}" />
        <TextBlock Text="{Binding SelectedCount, StringFormat='{}{0} selecionados'}" Visibility="{Binding SelectedCount, Converter={StaticResource Int2VisibilityConverter}}" />
      </StackPanel>
    </Border>

    <!--  Loading overlay  -->
    <Border
      Grid.RowSpan="3"
      Background="#80000000"
      Visibility="{Binding IsLoading, Converter={StaticResource Boolean2VisibilityConverter}}">
      <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
        <hc:LoadingCircle />
        <TextBlock
          Margin="0,8,0,0"
          Foreground="White"
          Text="Carregando arquivos..." />
      </StackPanel>
    </Border>
  </Grid>
</UserControl>
